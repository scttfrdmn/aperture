name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

permissions:
  contents: read

jobs:
  terraform-validate:
    name: Terraform Validate
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: "~1.5"

    - name: Terraform Format Check
      run: terraform fmt -check -recursive

    - name: Terraform Init (DynamoDB Module)
      run: terraform init -backend=false
      working-directory: infrastructure/terraform/modules/dynamodb

    - name: Terraform Validate (DynamoDB Module)
      run: terraform validate
      working-directory: infrastructure/terraform/modules/dynamodb

    - name: Terraform Init (S3 Module)
      run: terraform init -backend=false
      working-directory: infrastructure/terraform/modules/s3

    - name: Terraform Validate (S3 Module)
      run: terraform validate
      working-directory: infrastructure/terraform/modules/s3

    - name: Terraform Init (Cognito Module)
      run: terraform init -backend=false
      working-directory: infrastructure/terraform/modules/cognito

    - name: Terraform Validate (Cognito Module)
      run: terraform validate
      working-directory: infrastructure/terraform/modules/cognito

    - name: Terraform Init (CloudFront Module)
      run: terraform init -backend=false
      working-directory: infrastructure/terraform/modules/cloudfront

    - name: Terraform Validate (CloudFront Module)
      run: terraform validate
      working-directory: infrastructure/terraform/modules/cloudfront

    - name: Terraform Init (EventBridge Module)
      run: terraform init -backend=false
      working-directory: infrastructure/terraform/modules/eventbridge

    - name: Terraform Validate (EventBridge Module)
      run: terraform validate
      working-directory: infrastructure/terraform/modules/eventbridge

    - name: Terraform Init (Lambda Module)
      run: terraform init -backend=false
      working-directory: infrastructure/terraform/modules/lambda

    - name: Terraform Validate (Lambda Module)
      run: terraform validate
      working-directory: infrastructure/terraform/modules/lambda

    - name: Terraform Init (API Gateway Module)
      run: terraform init -backend=false
      working-directory: infrastructure/terraform/modules/api-gateway

    - name: Terraform Validate (API Gateway Module)
      run: terraform validate
      working-directory: infrastructure/terraform/modules/api-gateway

  lambda-tests:
    name: Lambda Function Tests
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install dependencies - Auth Lambda
      run: |
        cd lambda/auth
        pip install -r requirements.txt
        pip install pytest boto3 moto

    - name: Install dependencies - Presigned URLs Lambda
      run: |
        cd lambda/presigned-urls
        pip install -r requirements.txt
        pip install pytest boto3 moto

    - name: Install dependencies - DOI Minting Lambda
      run: |
        cd lambda/doi-minting
        pip install -r requirements.txt
        pip install pytest boto3 moto requests-mock

    - name: Run Python linting
      run: |
        pip install pylint
        find lambda -name "*.py" -exec pylint --disable=C,R,W {} + || true

    - name: Check Python syntax
      run: |
        python -m py_compile lambda/auth/handler.py
        python -m py_compile lambda/presigned-urls/handler.py
        python -m py_compile lambda/doi-minting/handler.py

  terraform-docs:
    name: Documentation Check
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Check README files exist
      run: |
        for module in infrastructure/terraform/modules/*/; do
          if [ ! -f "${module}README.md" ]; then
            echo "Missing README.md in $module"
            exit 1
          fi
        done

    - name: Verify CHANGELOG is updated
      if: github.event_name == 'pull_request'
      run: |
        if ! git diff --name-only origin/${{ github.base_ref }} | grep -q "CHANGELOG.md"; then
          echo "Warning: CHANGELOG.md not updated"
          echo "Please update CHANGELOG.md with your changes"
        fi

  security:
    name: Security Scan
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Run Checkov (Terraform Security Scanner)
      uses: bridgecrewio/checkov-action@master
      with:
        directory: infrastructure/terraform
        framework: terraform
        soft_fail: true  # Don't fail build, just warn
        output_format: cli
